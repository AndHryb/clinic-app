version: "3.8"

services:
  app:
    image: anhryb/clinic-app-pg:latest
    container_name: clinic
    command: npm start
    ports:
    - 3000:3000
    working_dir: /app
    volumes:
      - ./:/clinic-app
    environment:
      NODE_ENV: dev
      PORT: 3000
      TTL: 30000
      REDIS_HOST: redis
      PG_HOST: db
      PG_USER: anhryb
      PG_PORT: 5432
      PG_PASSWORD: 143234
      PG_DB: clinic_db
      JWT_TTL: 600
      JWT_KEY: 2hrtn1
      SALT: 10
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
  db:
    image: postgres:13.3
    environment:
      POSTGRES_DB: "clinic_db"
      POSTGRES_USER: "anhryb"
      POSTGRES_PASSWORD: "143234"
      PGDATA: "/var/lib/postgresql/data/pgdata"
    volumes:
      - ../helpers/migraions:/docker-entrypoint-initdb.d
      - pg-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U anhryb -d clinic_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 4G
  redis:
    image: redis:6.2
    container_name: redis
    restart: always
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 1s
      timeout: 3s
      retries: 30   
volumes:
    pg-data:




